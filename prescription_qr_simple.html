<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å¥ä¿è™•æ–¹ç®‹è½‰ QR Codeï¼ˆç°¡åŒ–ç‰ˆï¼‰</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 8px;
            font-size: 24px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 13px;
        }
        
        .photo-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #667eea;
        }
        
        .section-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        video, #captured-image {
            width: 100%;
            border-radius: 8px;
            margin: 12px 0;
            background: #000;
            display: none;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
        }
        
        button {
            flex: 1;
            min-width: 110px;
            padding: 11px 14px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .form-row.full {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 13px;
        }
        
        label .required {
            color: #dc3545;
            margin-left: 2px;
        }
        
        input, select {
            width: 100%;
            padding: 9px 11px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .med-table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 13px;
            overflow-x: auto;
            display: block;
        }
        
        .med-table table {
            width: 100%;
        }
        
        .med-table th {
            background: #f8f9fa;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #dee2e6;
            font-size: 12px;
        }
        
        .med-table td {
            padding: 4px;
            border: 1px solid #dee2e6;
        }
        
        .med-table input {
            padding: 6px 4px;
            font-size: 12px;
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .btn-add {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .tip-box {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
            color: #2e7d32;
            border-left: 3px solid #4caf50;
        }
        
        .warning-box {
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
            color: #856404;
            border-left: 3px solid #ffc107;
        }
        
        #qrcode-container {
            display: none;
            text-align: center;
            margin-top: 24px;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        #qrcode {
            display: inline-block;
            padding: 16px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 16px 0;
        }
        
        .qr-info {
            color: #666;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .qr-data-preview {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            text-align: left;
            font-size: 11px;
            font-family: "Courier New", monospace;
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ å¥ä¿è™•æ–¹ç®‹è½‰ QR Code</h1>
        <p class="subtitle">å‡Œæ›œè—¥å±€ - ç°¡åŒ–ç‰ˆï¼ˆç´”æ‰‹å‹•è¼¸å…¥ï¼‰</p>

        <!-- æ‹ç…§åƒè€ƒå€ï¼ˆå¯é¸ï¼‰ -->
        <div class="photo-section">
            <div class="section-title">ğŸ“¸ æ‹æ”è™•æ–¹ç®‹ï¼ˆåƒè€ƒç”¨ï¼‰</div>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                æ‹ç…§å¾Œå¯å°ç…§ç´™æœ¬è™•æ–¹è¼¸å…¥è³‡æ–™
            </p>

            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <img id="captured-image" alt="è™•æ–¹ç®‹">
            
            <div class="button-group">
                <button class="btn-primary" onclick="startCamera()" id="start-camera-btn">
                    ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ
                </button>
                <button class="btn-success" onclick="capturePhoto()" id="capture-btn" style="display:none;">
                    âœ“ æ‹ç…§
                </button>
                <button class="btn-warning" onclick="retakePhoto()" id="retake-btn" style="display:none;">
                    â†» é‡æ‹
                </button>
                <button class="btn-secondary" onclick="uploadPhoto()">
                    ğŸ“ é¸æ“‡ç…§ç‰‡
                </button>
            </div>
            <input type="file" id="file-input" accept="image/*" style="display:none;">
        </div>

        <!-- è¼¸å…¥è¡¨å–® -->
        <div>
            <h3 style="margin-bottom: 16px; color: #333; font-size: 18px;">âœï¸ è¼¸å…¥è™•æ–¹è³‡æ–™</h3>
            
            <div class="tip-box">
                ğŸ’¡ è«‹å°ç…§ç´™æœ¬è™•æ–¹ç®‹ä»”ç´°è¼¸å…¥æ‰€æœ‰æ¬„ä½
            </div>

            <!-- åŸºæœ¬è³‡æ–™ -->
            <div class="form-row">
                <div class="form-group">
                    <label>é†«äº‹æ©Ÿæ§‹ä»£è™Ÿ <span class="required">*</span></label>
                    <input type="text" id="hospitalCode" placeholder="10ç¢¼æ•¸å­—" maxlength="10" value="3531066728">
                </div>
                <div class="form-group">
                    <label>è™•æ–¹é¡å‹ <span class="required">*</span></label>
                    <select id="prescType">
                        <option value="1" selected>ä¸€èˆ¬è™•æ–¹ç®‹</option>
                        <option value="2">é€£çºŒè™•æ–¹ç®‹</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>æ¡ˆä»¶åˆ†é¡ <span class="required">*</span></label>
                    <input type="text" id="caseType" placeholder="2ç¢¼æ•¸å­—" maxlength="2" value="09">
                </div>
                <div class="form-group">
                    <label>å°±é†«ç§‘åˆ¥ <span class="required">*</span></label>
                    <input type="text" id="deptCode" placeholder="å¦‚:09" maxlength="2">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>å§“å <span class="required">*</span></label>
                    <input type="text" id="patientName" placeholder="ç—…æ‚£å§“å">
                </div>
                <div class="form-group">
                    <label>èº«åˆ†è­‰å­—è™Ÿ <span class="required">*</span></label>
                    <input type="text" id="patientId" placeholder="10ç¢¼" maxlength="10">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸ <span class="required">*</span></label>
                    <input type="text" id="birthday" placeholder="YYYMMDD (å¦‚:0590218)" maxlength="7">
                </div>
                <div class="form-group">
                    <label>å°±é†«æ—¥æœŸ <span class="required">*</span></label>
                    <input type="text" id="visitDate" placeholder="YYYMMDD (å¦‚:1141108)" maxlength="7">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>å¥ä¿å¡åºè™Ÿ <span class="required">*</span></label>
                    <input type="text" id="cardSeq" placeholder="4ç¢¼æ•¸å­—" maxlength="4">
                </div>
                <div class="form-group">
                    <label>çµ¦è—¥æ—¥ä»½ <span class="required">*</span></label>
                    <input type="number" id="drugDays" placeholder="å¤©æ•¸" value="3">
                </div>
            </div>

            <div class="form-row full">
                <div class="form-group">
                    <label>åœ‹éš›ç–¾ç—…åˆ†é¡ç¢¼ <span class="required">*</span></label>
                    <input type="text" id="icd" placeholder="å¦‚ï¼šJ209 (å¤šå€‹ç”¨,åˆ†éš”)">
                </div>
            </div>

            <div class="form-row full">
                <div class="form-group">
                    <label>è¨ºæ²»é†«å¸«ä»£è™Ÿ <span class="required">*</span></label>
                    <input type="text" id="doctorCode" placeholder="10ç¢¼" value="3531066728">
                </div>
            </div>

            <!-- è—¥å“æ¸…å–® -->
            <div class="form-group" style="margin-top: 20px;">
                <label>ğŸ’Š è—¥å“æ¸…å–® <span class="required">*</span></label>
                <div class="warning-box">
                    âš ï¸ è«‹ä»”ç´°æ ¸å°è—¥å“ä»£è™Ÿï¼ˆ10ç¢¼ï¼‰å’ŒåŠ‘é‡
                </div>
                <div class="med-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 28%;">è—¥å“ä»£è™Ÿ</th>
                                <th style="width: 13%;">ç”¨é‡</th>
                                <th style="width: 13%;">é »ç‡</th>
                                <th style="width: 13%;">é€”å¾‘</th>
                                <th style="width: 13%;">ç¸½é‡</th>
                                <th style="width: 20%;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="med-tbody">
                            <!-- è—¥å“åˆ—è¡¨ -->
                        </tbody>
                    </table>
                </div>
                <button class="btn-add" onclick="addMedRow()">â• æ–°å¢è—¥å“</button>
            </div>

            <!-- ç”ŸæˆæŒ‰éˆ• -->
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn-primary" onclick="generateQRCode()">
                    ğŸ“± ç”Ÿæˆå¥ä¿ QR Code
                </button>
                <button class="btn-secondary" onclick="resetAll()">
                    ğŸ”„ æ¸…ç©ºé‡å¡«
                </button>
            </div>
        </div>

        <!-- QR Code é¡¯ç¤º -->
        <div id="qrcode-container">
            <h2 style="color: #333; margin-bottom: 16px; font-size: 20px;">âœ… å¥ä¿ QR Code å·²ç”Ÿæˆ</h2>
            
            <div class="qr-data-preview" id="qr-data-preview"></div>
            
            <div id="qrcode"></div>
            <p class="qr-info">è«‹ç”¨é›»è…¦ WebCam æƒææ­¤ QR Code</p>
            
            <button class="btn-success" onclick="resetAll()" style="margin-top: 16px;">
                â• è™•ç†ä¸‹ä¸€å¼µè™•æ–¹
            </button>
        </div>
    </div>

    <script>
        let stream = null;
        let medCount = 0;

        // é é¢è¼‰å…¥æ™‚åŠ å…¥ä¸€è¡Œç©ºç™½è—¥å“
        window.addEventListener('load', () => {
            addMedRow();
        });

        // å•Ÿå‹•ç›¸æ©Ÿ
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.style.display = 'block';
                
                document.getElementById('start-camera-btn').style.display = 'none';
                document.getElementById('capture-btn').style.display = 'inline-block';
            } catch (err) {
                alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ä½¿ç”¨ã€Œé¸æ“‡ç…§ç‰‡ã€åŠŸèƒ½');
            }
        }

        // æ‹ç…§
        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('captured-image');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            capturedImage.src = canvas.toDataURL('image/jpeg');
            capturedImage.style.display = 'block';
            
            video.style.display = 'none';
            document.getElementById('capture-btn').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'inline-block';
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        // é‡æ‹
        function retakePhoto() {
            document.getElementById('captured-image').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'none';
            startCamera();
        }

        // ä¸Šå‚³ç…§ç‰‡
        function uploadPhoto() {
            document.getElementById('file-input').click();
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    const capturedImage = document.getElementById('captured-image');
                    capturedImage.src = event.target.result;
                    capturedImage.style.display = 'block';
                    
                    document.getElementById('video').style.display = 'none';
                    document.getElementById('start-camera-btn').style.display = 'none';
                    document.getElementById('retake-btn').style.display = 'inline-block';
                };
                
                reader.readAsDataURL(file);
            }
        });

        // æ–°å¢è—¥å“åˆ—
        function addMedRow() {
            medCount++;
            const tbody = document.getElementById('med-tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" id="medCode${medCount}" placeholder="AC12345678"></td>
                <td><input type="text" id="medDosage${medCount}" placeholder="1"></td>
                <td><input type="text" id="medFreq${medCount}" placeholder="TID"></td>
                <td><input type="text" id="medRoute${medCount}" placeholder="PO"></td>
                <td><input type="text" id="medQty${medCount}" placeholder="9"></td>
                <td><button class="btn-remove" onclick="removeMedRow(this)">åˆªé™¤</button></td>
            `;
        }

        // åˆªé™¤è—¥å“åˆ—
        function removeMedRow(btn) {
            btn.closest('tr').remove();
        }

        // ç”Ÿæˆå¥ä¿ QR Code
        function generateQRCode() {
            const hospitalCode = document.getElementById('hospitalCode').value.trim();
            const prescType = document.getElementById('prescType').value;
            const caseType = document.getElementById('caseType').value.trim();
            const patientName = document.getElementById('patientName').value.trim();
            const patientId = document.getElementById('patientId').value.trim();
            const birthday = document.getElementById('birthday').value.trim();
            const deptCode = document.getElementById('deptCode').value.trim();
            const visitDate = document.getElementById('visitDate').value.trim();
            const cardSeq = document.getElementById('cardSeq').value.trim();
            const drugDays = document.getElementById('drugDays').value.trim();
            const icd = document.getElementById('icd').value.trim();
            const doctorCode = document.getElementById('doctorCode').value.trim();

            if (!hospitalCode || !patientName || !patientId || !visitDate) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆ*è™Ÿæ¨™ç¤ºï¼‰');
                return;
            }

            const medications = [];
            const tbody = document.getElementById('med-tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach((row, index) => {
                const num = index + 1;
                const code = document.getElementById('medCode' + num)?.value.trim();
                const dosage = document.getElementById('medDosage' + num)?.value.trim();
                const freq = document.getElementById('medFreq' + num)?.value.trim();
                const route = document.getElementById('medRoute' + num)?.value.trim();
                const qty = document.getElementById('medQty' + num)?.value.trim();
                
                if (code) {
                    medications.push({ code, dosage, freq, route, qty });
                }
            });

            if (medications.length === 0) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€é …è—¥å“');
                return;
            }

            // çµ„åˆå¥ä¿ QR Code æ ¼å¼
            let qrString = [
                hospitalCode,
                prescType,
                caseType,
                patientName,
                patientId,
                birthday,
                deptCode,
                visitDate,
                cardSeq,
                drugDays,
                '',
                icd.split(',').map(i => i.trim() + '#').join(''),
                doctorCode,
                ''
            ].join(';');

            medications.forEach(med => {
                qrString += ';' + [
                    med.code,
                    med.dosage,
                    med.freq,
                    med.route,
                    med.qty
                ].join(';');
            });

            document.getElementById('qr-data-preview').textContent = qrString;

            if (qrString.length > 2900) {
                alert('è³‡æ–™éé•·ï¼Œå¯èƒ½ç„¡æ³•æƒæï¼å»ºè­°ç°¡åŒ–æˆ–åˆ†æ‰¹è™•ç†');
            }

            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';

            new QRCode(qrcodeDiv, {
                text: qrString,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            document.getElementById('qrcode-container').style.display = 'block';
            document.getElementById('qrcode-container').scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
        }

        // é‡ç½®
        function resetAll() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                location.reload();
            }
        }
    </script>
</body>
</html>
