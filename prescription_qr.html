<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å¥ä¿è™•æ–¹ç®‹ OCR è½‰ QR Code</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 8px;
            font-size: 24px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 13px;
        }
        
        .camera-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #667eea;
        }
        
        .section-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        video, #captured-image {
            width: 100%;
            border-radius: 8px;
            margin: 12px 0;
            background: #000;
        }
        
        video { display: none; }
        #captured-image { 
            display: none;
            border: 2px solid #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
        }
        
        button {
            flex: 1;
            min-width: 110px;
            padding: 11px 14px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .progress-section {
            display: none;
            margin: 16px 0;
            padding: 16px;
            background: #e3f2fd;
            border-radius: 8px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 22px;
            background: #fff;
            border-radius: 11px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
        }
        
        .progress-status {
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .form-section {
            display: none;
            margin-top: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .form-row.full {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 13px;
        }
        
        label .required {
            color: #dc3545;
            margin-left: 2px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 9px 11px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .med-table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 13px;
            overflow-x: auto;
            display: block;
        }
        
        .med-table table {
            width: 100%;
        }
        
        .med-table th {
            background: #f8f9fa;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #dee2e6;
            font-size: 12px;
        }
        
        .med-table td {
            padding: 4px;
            border: 1px solid #dee2e6;
        }
        
        .med-table input {
            padding: 6px 4px;
            font-size: 12px;
        }
        
        .med-row {
            background: white;
        }
        
        .med-row:hover {
            background: #f8f9fa;
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .btn-add {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .tip-box {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
            color: #2e7d32;
            border-left: 3px solid #4caf50;
        }
        
        .warning-box {
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
            color: #856404;
            border-left: 3px solid #ffc107;
        }
        
        .ocr-preview {
            display: none;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: "Courier New", monospace;
            font-size: 11px;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
        }
        
        #qrcode-container {
            display: none;
            text-align: center;
            margin-top: 24px;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        #qrcode {
            display: inline-block;
            padding: 16px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 16px 0;
        }
        
        .qr-info {
            color: #666;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .qr-data-preview {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            text-align: left;
            font-size: 11px;
            font-family: "Courier New", monospace;
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .button-group button {
                min-width: 100px;
                font-size: 13px;
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ å¥ä¿è™•æ–¹ç®‹ OCR è½‰ QR Code</h1>
        <p class="subtitle">å‡Œæ›œè—¥å±€ - ç¬¦åˆå¥ä¿å±€ QR Code è¦ç¯„</p>

        <!-- æ‹ç…§å€ -->
        <div class="camera-section">
            <div class="section-title">ğŸ“¸ æ‹æ”è™•æ–¹ç®‹</div>
            
            <div class="tip-box">
                ğŸ’¡ <strong>æ‹æ”æç¤ºï¼š</strong>å…‰ç·šå……è¶³ã€è™•æ–¹ç®‹å¹³æ•´ã€å­—è·¡æ¸…æ™°ã€é¿å…åå…‰
            </div>

            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <img id="captured-image" alt="è™•æ–¹ç®‹">
            
            <div class="button-group">
                <button class="btn-primary" onclick="startCamera()" id="start-camera-btn">
                    ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ
                </button>
                <button class="btn-success" onclick="capturePhoto()" id="capture-btn" style="display:none;">
                    âœ“ æ‹ç…§
                </button>
                <button class="btn-warning" onclick="retakePhoto()" id="retake-btn" style="display:none;">
                    â†» é‡æ‹
                </button>
                <button class="btn-secondary" onclick="uploadPhoto()">
                    ğŸ“ é¸æ“‡ç…§ç‰‡
                </button>
            </div>
            <input type="file" id="file-input" accept="image/*" style="display:none;">
        </div>

        <!-- é€²åº¦æ¢ -->
        <div class="progress-section" id="progress-section">
            <div class="section-title">ğŸ” è¾¨è­˜è™•æ–¹ç®‹ä¸­...</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>
            <div class="progress-status" id="progress-status">åˆå§‹åŒ–...</div>
        </div>

        <!-- OCR é è¦½ -->
        <div class="ocr-preview" id="ocr-preview"></div>

        <!-- ç·¨è¼¯è¡¨å–® -->
        <div class="form-section" id="edit-form">
            <h3 style="margin-bottom: 16px; color: #333; font-size: 18px;">âœï¸ ç¢ºèªè™•æ–¹è³‡æ–™</h3>
            
            <div class="warning-box">
                âš ï¸ è«‹ä»”ç´°æ ¸å° OCR è¾¨è­˜çµæœï¼Œç‰¹åˆ¥æ˜¯è—¥å“ä»£è™Ÿå’ŒåŠ‘é‡
            </div>

            <!-- åŸºæœ¬è³‡æ–™ -->
            <div class="form-row">
                <div class="form-group">
                    <label>é†«äº‹æ©Ÿæ§‹ä»£è™Ÿ <span class="required">*</span></label>
                    <input type="text" id="hospitalCode" placeholder="10ç¢¼æ•¸å­—" maxlength="10">
                </div>
                <div class="form-group">
                    <label>è™•æ–¹é¡å‹ <span class="required">*</span></label>
                    <select id="prescType">
                        <option value="1">ä¸€èˆ¬è™•æ–¹ç®‹</option>
                        <option value="2">é€£çºŒè™•æ–¹ç®‹</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>æ¡ˆä»¶åˆ†é¡ <span class="required">*</span></label>
                    <input type="text" id="caseType" placeholder="2ç¢¼æ•¸å­—" maxlength="2" value="09">
                </div>
                <div class="form-group">
                    <label>å°±é†«ç§‘åˆ¥ <span class="required">*</span></label>
                    <input type="text" id="deptCode" placeholder="2ç¢¼è‹±æ•¸å­—" maxlength="2">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>å§“å <span class="required">*</span></label>
                    <input type="text" id="patientName" placeholder="ç—…æ‚£å§“å">
                </div>
                <div class="form-group">
                    <label>èº«åˆ†è­‰å­—è™Ÿ <span class="required">*</span></label>
                    <input type="text" id="patientId" placeholder="10ç¢¼" maxlength="10">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸ <span class="required">*</span></label>
                    <input type="text" id="birthday" placeholder="YYYMMDD (æ°‘åœ‹å¹´)" maxlength="7">
                </div>
                <div class="form-group">
                    <label>å°±é†«æ—¥æœŸ <span class="required">*</span></label>
                    <input type="text" id="visitDate" placeholder="YYYMMDD (æ°‘åœ‹å¹´)" maxlength="7">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>å¥ä¿å¡åºè™Ÿ <span class="required">*</span></label>
                    <input type="text" id="cardSeq" placeholder="4ç¢¼æ•¸å­—" maxlength="4">
                </div>
                <div class="form-group">
                    <label>çµ¦è—¥æ—¥ä»½ <span class="required">*</span></label>
                    <input type="number" id="drugDays" placeholder="å¤©æ•¸" value="3">
                </div>
            </div>

            <div class="form-row full">
                <div class="form-group">
                    <label>åœ‹éš›ç–¾ç—…åˆ†é¡ç¢¼ <span class="required">*</span></label>
                    <input type="text" id="icd" placeholder="å¦‚ï¼šJ209 (å¤šå€‹ç”¨,åˆ†éš”)">
                </div>
            </div>

            <div class="form-row full">
                <div class="form-group">
                    <label>è¨ºæ²»é†«å¸«ä»£è™Ÿ <span class="required">*</span></label>
                    <input type="text" id="doctorCode" placeholder="10ç¢¼ (å¯ç”¨é†«äº‹æ©Ÿæ§‹ä»£è™Ÿ)">
                </div>
            </div>

            <!-- è—¥å“æ¸…å–® -->
            <div class="form-group" style="margin-top: 20px;">
                <label>ğŸ’Š è—¥å“æ¸…å–® <span class="required">*</span></label>
                <div class="med-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 28%;">è—¥å“ä»£è™Ÿ</th>
                                <th style="width: 13%;">ç”¨é‡</th>
                                <th style="width: 13%;">é »ç‡</th>
                                <th style="width: 13%;">é€”å¾‘</th>
                                <th style="width: 13%;">ç¸½é‡</th>
                                <th style="width: 20%;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="med-tbody">
                            <!-- è—¥å“åˆ—è¡¨å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                <button class="btn-add" onclick="addMedRow()">â• æ–°å¢è—¥å“</button>
            </div>

            <!-- ç”ŸæˆæŒ‰éˆ• -->
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn-primary" onclick="generateQRCode()">
                    ğŸ“± ç”Ÿæˆå¥ä¿ QR Code
                </button>
                <button class="btn-secondary" onclick="resetAll()">
                    ğŸ”„ å…¨éƒ¨é‡ä¾†
                </button>
            </div>
        </div>

        <!-- QR Code é¡¯ç¤º -->
        <div id="qrcode-container">
            <h2 style="color: #333; margin-bottom: 16px; font-size: 20px;">âœ… å¥ä¿ QR Code å·²ç”Ÿæˆ</h2>
            
            <div class="qr-data-preview" id="qr-data-preview"></div>
            
            <div id="qrcode"></div>
            <p class="qr-info">è«‹ç”¨é›»è…¦ WebCam æƒææ­¤ QR Code</p>
            
            <button class="btn-success" onclick="resetAll()" style="margin-top: 16px;">
                â• è™•ç†ä¸‹ä¸€å¼µè™•æ–¹
            </button>
        </div>
    </div>

    <script>
        let stream = null;
        let ocrWorker = null;
        let medCount = 0;

        // åˆå§‹åŒ– OCR
        async function initOCR() {
            if (!ocrWorker) {
                ocrWorker = await Tesseract.createWorker('chi_tra+eng', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            updateProgress(Math.round(m.progress * 100), 'è¾¨è­˜ä¸­...');
                        }
                    }
                });
            }
            return ocrWorker;
        }

        // æ›´æ–°é€²åº¦
        function updateProgress(percent, status) {
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-bar').textContent = percent + '%';
            document.getElementById('progress-status').textContent = status;
        }

        // å•Ÿå‹•ç›¸æ©Ÿ
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.style.display = 'block';
                
                document.getElementById('start-camera-btn').style.display = 'none';
                document.getElementById('capture-btn').style.display = 'inline-block';
            } catch (err) {
                alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ä½¿ç”¨ã€Œé¸æ“‡ç…§ç‰‡ã€åŠŸèƒ½');
            }
        }

        // æ‹ç…§
        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('captured-image');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                capturedImage.src = URL.createObjectURL(blob);
                capturedImage.style.display = 'block';
                
                video.style.display = 'none';
                document.getElementById('capture-btn').style.display = 'none';
                document.getElementById('retake-btn').style.display = 'inline-block';
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                performOCR(blob);
            }, 'image/jpeg', 0.95);
        }

        // é‡æ‹
        function retakePhoto() {
            document.getElementById('captured-image').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('ocr-preview').style.display = 'none';
            document.getElementById('edit-form').style.display = 'none';
            startCamera();
        }

        // ä¸Šå‚³ç…§ç‰‡
        function uploadPhoto() {
            document.getElementById('file-input').click();
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    const capturedImage = document.getElementById('captured-image');
                    capturedImage.src = event.target.result;
                    capturedImage.style.display = 'block';
                    
                    document.getElementById('video').style.display = 'none';
                    document.getElementById('start-camera-btn').style.display = 'none';
                    document.getElementById('retake-btn').style.display = 'inline-block';
                    
                    performOCR(file);
                };
                
                reader.readAsDataURL(file);
            }
        });

        // åŸ·è¡Œ OCR
        async function performOCR(imageBlob) {
            const progressSection = document.getElementById('progress-section');
            const ocrPreview = document.getElementById('ocr-preview');
            const editForm = document.getElementById('edit-form');
            
            try {
                progressSection.style.display = 'block';
                ocrPreview.style.display = 'none';
                editForm.style.display = 'none';
                
                updateProgress(0, 'åˆå§‹åŒ– OCR...');
                
                const worker = await initOCR();
                updateProgress(20, 'é–‹å§‹è¾¨è­˜...');
                
                const { data: { text } } = await worker.recognize(imageBlob);
                
                updateProgress(100, 'è¾¨è­˜å®Œæˆï¼');
                
                setTimeout(() => {
                    progressSection.style.display = 'none';
                    ocrPreview.textContent = text;
                    ocrPreview.style.display = 'block';
                    displayOCRResult(text);
                }, 500);
                
            } catch (error) {
                alert('OCR å¤±æ•—ï¼š' + error.message);
                progressSection.style.display = 'none';
            }
        }

        // è§£æè™•æ–¹ç®‹
        function parsePrescriptionText(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const data = {
                hospitalCode: '',
                prescType: '1',
                caseType: '09',
                patientName: '',
                patientId: '',
                birthday: '',
                deptCode: '',
                visitDate: '',
                cardSeq: '',
                drugDays: '3',
                icd: '',
                doctorCode: '',
                medications: []
            };

            // é†«äº‹æ©Ÿæ§‹ä»£è™Ÿ
            for (let line of lines) {
                const match = line.match(/\b(\d{10})\b/);
                if (match && !data.hospitalCode) {
                    data.hospitalCode = match[1];
                    break;
                }
            }

            // å§“å
            for (let line of lines) {
                if (line.includes('å§“å') || line.includes('ä»£ç¢¼æˆ–åç¨±')) {
                    const match = line.match(/[:ï¼š]\s*([^\s]+)/);
                    if (match) {
                        data.patientName = match[1].replace(/[0-9]/g, '').trim();
                        break;
                    }
                }
            }

            // èº«åˆ†è­‰å­—è™Ÿ
            for (let line of lines) {
                const match = line.match(/([A-Z]\d{9})/);
                if (match) {
                    data.patientId = match[1];
                    break;
                }
            }

            // å‡ºç”Ÿæ—¥æœŸ
            for (let line of lines) {
                if (line.includes('å‡ºç”Ÿæ—¥æœŸ')) {
                    const match = line.match(/(\d{3})\D?(\d{2})\D?(\d{2})/);
                    if (match) {
                        data.birthday = match[1] + match[2] + match[3];
                        break;
                    }
                }
            }

            // å°±é†«ç§‘åˆ¥å’Œæ¡ˆé¡
            for (let line of lines) {
                if (line.includes('å°±é†«ç§‘åˆ¥') || line.includes('æ¡ˆé¡')) {
                    const match = line.match(/[:ï¼š]\s*(\d{2})/);
                    if (match) {
                        if (line.includes('æ¡ˆé¡')) {
                            data.caseType = match[1];
                        } else {
                            data.deptCode = match[1];
                        }
                    }
                }
            }

            // å°±é†«æ—¥æœŸ
            for (let line of lines) {
                if (line.includes('å°±é†«æ—¥æœŸ')) {
                    const match = line.match(/(\d{3})\D?(\d{2})\D?(\d{2})/);
                    if (match) {
                        data.visitDate = match[1] + match[2] + match[3];
                        break;
                    }
                }
            }

            // å¥ä¿å¡åºè™Ÿ
            for (let line of lines) {
                if (line.includes('å¥ä¿å¡')) {
                    const match = line.match(/(\d{4})/);
                    if (match) {
                        data.cardSeq = match[1];
                        break;
                    }
                }
            }

            // çµ¦è—¥æ—¥ä»½
            for (let line of lines) {
                if (line.includes('çµ¦è—¥') || line.includes('è—¥é¡')) {
                    const match = line.match(/(\d+)/);
                    if (match) {
                        data.drugDays = match[1];
                        break;
                    }
                }
            }

            // ICD ç¢¼
            for (let line of lines) {
                const match = line.match(/([A-Z]\d{2,4})/);
                if (match && !data.icd) {
                    data.icd = match[1];
                }
            }

            // è§£æè—¥å“
            const medications = [];
            let inMedSection = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.includes('è—¥å“åç¨±') || line.includes('è—¥å“åç¨±å“ç¢¼é …')) {
                    inMedSection = true;
                    continue;
                }
                
                const medMatch = line.match(/^([A-Z]{2}\d{8})/);
                if (medMatch || (inMedSection && /^[A-Z0-9]{10}/.test(line))) {
                    const medCode = medMatch ? medMatch[1] : line.substring(0, 10);
                    
                    const dosageMatch = line.match(/([\d.]+)\s*[\/]?\s*(éŒ |ç²’|åŒ…|é¡†|#|tab|cap)/i);
                    const freqMatch = line.match(/(TID|BID|QID|QD|HS|PRN)/i);
                    const routeMatch = line.match(/(PO|IV|IM|SC|SL)/i);
                    const qtyMatch = line.match(/(\d+[\.]?\d*)\s*$/);
                    
                    medications.push({
                        code: medCode,
                        dosage: dosageMatch ? dosageMatch[1] : '1',
                        frequency: freqMatch ? freqMatch[1] : 'TID',
                        route: routeMatch ? routeMatch[1] : 'PO',
                        quantity: qtyMatch ? qtyMatch[1] : '0'
                    });
                }
            }

            data.medications = medications;
            data.doctorCode = data.hospitalCode;
            
            return data;
        }

        // é¡¯ç¤º OCR çµæœ
        function displayOCRResult(text) {
            const data = parsePrescriptionText(text);
            
            document.getElementById('hospitalCode').value = data.hospitalCode;
            document.getElementById('prescType').value = data.prescType;
            document.getElementById('caseType').value = data.caseType;
            document.getElementById('patientName').value = data.patientName;
            document.getElementById('patientId').value = data.patientId;
            document.getElementById('birthday').value = data.birthday;
            document.getElementById('deptCode').value = data.deptCode;
            document.getElementById('visitDate').value = data.visitDate;
            document.getElementById('cardSeq').value = data.cardSeq;
            document.getElementById('drugDays').value = data.drugDays;
            document.getElementById('icd').value = data.icd;
            document.getElementById('doctorCode').value = data.doctorCode;
            
            document.getElementById('med-tbody').innerHTML = '';
            medCount = 0;
            
            if (data.medications.length > 0) {
                data.medications.forEach(med => {
                    addMedRow(med);
                });
            } else {
                addMedRow();
            }
            
            document.getElementById('edit-form').style.display = 'block';
            document.getElementById('edit-form').scrollIntoView({ behavior: 'smooth' });
        }

        // æ–°å¢è—¥å“åˆ—
        function addMedRow(medData = null) {
            medCount++;
            const tbody = document.getElementById('med-tbody');
            const row = tbody.insertRow();
            row.className = 'med-row';
            row.innerHTML = `
                <td><input type="text" id="medCode${medCount}" value="${medData?.code || ''}" placeholder="10ç¢¼"></td>
                <td><input type="text" id="medDosage${medCount}" value="${medData?.dosage || ''}" placeholder="1"></td>
                <td><input type="text" id="medFreq${medCount}" value="${medData?.frequency || ''}" placeholder="TID"></td>
                <td><input type="text" id="medRoute${medCount}" value="${medData?.route || ''}" placeholder="PO"></td>
                <td><input type="text" id="medQty${medCount}" value="${medData?.quantity || ''}" placeholder="æ•¸é‡"></td>
                <td><button class="btn-remove" onclick="removeMedRow(this)">åˆªé™¤</button></td>
            `;
        }

        // åˆªé™¤è—¥å“åˆ—
        function removeMedRow(btn) {
            btn.closest('tr').remove();
        }

        // ç”Ÿæˆå¥ä¿ QR Code
        function generateQRCode() {
            const hospitalCode = document.getElementById('hospitalCode').value.trim();
            const prescType = document.getElementById('prescType').value;
            const caseType = document.getElementById('caseType').value.trim();
            const patientName = document.getElementById('patientName').value.trim();
            const patientId = document.getElementById('patientId').value.trim();
            const birthday = document.getElementById('birthday').value.trim();
            const deptCode = document.getElementById('deptCode').value.trim();
            const visitDate = document.getElementById('visitDate').value.trim();
            const cardSeq = document.getElementById('cardSeq').value.trim();
            const drugDays = document.getElementById('drugDays').value.trim();
            const icd = document.getElementById('icd').value.trim();
            const doctorCode = document.getElementById('doctorCode').value.trim();

            if (!hospitalCode || !patientName || !patientId || !visitDate) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            const medications = [];
            const tbody = document.getElementById('med-tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach((row, index) => {
                const num = index + 1;
                const code = document.getElementById('medCode' + num)?.value.trim();
                const dosage = document.getElementById('medDosage' + num)?.value.trim();
                const freq = document.getElementById('medFreq' + num)?.value.trim();
                const route = document.getElementById('medRoute' + num)?.value.trim();
                const qty = document.getElementById('medQty' + num)?.value.trim();
                
                if (code) {
                    medications.push({ code, dosage, freq, route, qty });
                }
            });

            if (medications.length === 0) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€é …è—¥å“');
                return;
            }

            // çµ„åˆå¥ä¿ QR Code æ ¼å¼
            let qrString = [
                hospitalCode,
                prescType,
                caseType,
                patientName,
                patientId,
                birthday,
                deptCode,
                visitDate,
                cardSeq,
                drugDays,
                '',
                icd.split(',').map(i => i.trim() + '#').join(''),
                doctorCode,
                ''
            ].join(';');

            medications.forEach(med => {
                qrString += ';' + [
                    med.code,
                    med.dosage,
                    med.freq,
                    med.route,
                    med.qty
                ].join(';');
            });

            document.getElementById('qr-data-preview').textContent = qrString;

            if (qrString.length > 2900) {
                alert('è³‡æ–™éé•·ï¼Œå¯èƒ½ç„¡æ³•æƒæï¼å»ºè­°ç°¡åŒ–æˆ–åˆ†æ‰¹è™•ç†');
            }

            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';

            new QRCode(qrcodeDiv, {
                text: qrString,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            document.getElementById('qrcode-container').style.display = 'block';
            document.getElementById('qrcode-container').scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
        }

        // é‡ç½®
        function resetAll() {
            location.reload();
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                initOCR().then(() => console.log('OCR å°±ç·’'));
            }, 1000);
        });
    </script>
</body>
</html>
